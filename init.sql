-- Oracle DB 초기화 스크립트 (Oracle Express Edition용 - 개발 환경)
-- 사용자 생성부터 테이블 생성까지 모든 작업 수행
-- 개발용 계정: play / ground

-- 컨테이너 데이터베이스에서 XEPDB1로 전환
ALTER SESSION SET CONTAINER = XEPDB1;

-- Oracle 18c 이상에서 일반 사용자 생성을 위한 설정
ALTER SESSION SET "_ORACLE_SCRIPT"=true;

-- 기존 사용자가 있다면 삭제 (무시하고 진행)
BEGIN
    EXECUTE IMMEDIATE 'DROP USER play CASCADE';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

-- 애플리케이션 사용자 생성 (개발용: play / ground)
CREATE USER play IDENTIFIED BY ground;

-- 기본 권한 부여
GRANT CONNECT, RESOURCE TO play;
GRANT UNLIMITED TABLESPACE TO play;
GRANT CREATE SEQUENCE TO play;
GRANT CREATE TRIGGER TO play;
GRANT CREATE VIEW TO play;
GRANT CREATE PROCEDURE TO play;
GRANT DBA TO play;
GRANT CREATE SESSION TO play;

-- 애플리케이션 사용자로 전환하여 테이블 생성
ALTER SESSION SET CURRENT_SCHEMA = play;

-- 기존 테이블 삭제 (안전하게)
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE FILES CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE COMMENTS CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE BOARDS CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE USERS CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP SEQUENCE USERS_SEQ';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

-- USERS 테이블 생성 (schema.sql과 동일한 구조)
CREATE TABLE USERS (
    ID NUMBER PRIMARY KEY,
    USERNAME VARCHAR2(50) NOT NULL,
    PASSWORD VARCHAR2(100) NOT NULL,
    ROLE VARCHAR2(20),
    BUSINESS_TOKEN VARCHAR2(255),
    CREATED_AT TIMESTAMP(6)
);

-- USERS 테이블용 시퀀스 생성
CREATE SEQUENCE USERS_SEQ START WITH 1 INCREMENT BY 1;

-- USERS 테이블용 트리거 생성 (ID 자동 증가)
CREATE OR REPLACE TRIGGER USERS_TRG
BEFORE INSERT ON USERS
FOR EACH ROW
BEGIN
  IF :NEW.ID IS NULL THEN
    SELECT USERS_SEQ.NEXTVAL INTO :NEW.ID FROM DUAL;
  END IF;
END;
/

-- BOARDS 테이블 생성 (schema.sql과 동일한 구조)
CREATE TABLE BOARDS (
    ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    TITLE VARCHAR2(200),
    CONTENT CLOB,
    USER_ID NUMBER,
    CREATED_AT TIMESTAMP,
    IS_NOTICE NUMBER(1) DEFAULT 0
);

-- COMMENTS 테이블 생성
CREATE TABLE COMMENTS (
  ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  BOARD_ID NUMBER,
  USER_ID NUMBER,
  CONTENT CLOB,
  CREATED_AT TIMESTAMP
);

-- FILES 테이블 생성
CREATE TABLE FILES(
  ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  BOARD_ID NUMBER,
  FILE_NAME VARCHAR2(255),
  FILE_PATH VARCHAR2(255),
  UPLOADED_AT TIMESTAMP,
  UPLOADED_BY NUMBER
);

-- 외래키 제약조건 추가 (선택사항 - 팀 협의 후 결정)
-- 데이터 무결성 보장 vs 개발 편의성 중 선택
-- 운영 환경 시뮬레이션을 위해서는 추가 권장

/*
ALTER TABLE BOARDS ADD CONSTRAINT FK_BOARDS_USER_ID 
    FOREIGN KEY (USER_ID) REFERENCES USERS(ID);

ALTER TABLE COMMENTS ADD CONSTRAINT FK_COMMENTS_BOARD_ID 
    FOREIGN KEY (BOARD_ID) REFERENCES BOARDS(ID);
    
ALTER TABLE COMMENTS ADD CONSTRAINT FK_COMMENTS_USER_ID 
    FOREIGN KEY (USER_ID) REFERENCES USERS(ID);

ALTER TABLE FILES ADD CONSTRAINT FK_FILES_BOARD_ID 
    FOREIGN KEY (BOARD_ID) REFERENCES BOARDS(ID);
    
ALTER TABLE FILES ADD CONSTRAINT FK_FILES_UPLOADED_BY 
    FOREIGN KEY (UPLOADED_BY) REFERENCES USERS(ID);
*/

-- 사용자 생성 완료 확인
SELECT 'User play created successfully in XEPDB1' AS STATUS FROM DUAL;
SELECT TABLE_NAME FROM USER_TABLES;

COMMIT; 